-- Запрос: Посчитай коэффициент эластичности для товаров

WITH prev_month AS (SELECT product_id, SUM(quantity) AS total_qty, AVG(unit_price) AS avg_price FROM sales WHERE sale_date BETWEEN DATE_TRUNC('month', CURRENT_DATE - INTERVAL '1' MONTH) AND DATE_TRUNC('month', CURRENT_DATE) - INTERVAL '1' DAY GROUP BY product_id), curr_month AS (SELECT product_id, SUM(quantity) AS total_qty, AVG(unit_price) AS avg_price FROM sales WHERE sale_date >= DATE_TRUNC('month', CURRENT_DATE) GROUP BY product_id) SELECT c.product_id, pr.product_name, c.total_qty as 'current_qty', p.total_qty as 'new_qty', c.avg_price as 'current_price', p.avg_price as 'new_price', ROUND(((c.total_qty - p.total_qty) / p.total_qty) / ((c.avg_price - p.avg_price) / p.avg_price), 2) AS price_elasticity FROM curr_month AS c INNER JOIN prev_month AS p ON c.product_id = p.product_id INNER JOIN products AS pr ON c.product_id = pr.product_id WHERE p.total_qty > 0 AND p.avg_price > 0 AND c.avg_price <> p.avg_price ORDER BY price_elasticity DESC;
